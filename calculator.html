<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

    <title>Construction Calculator</title>
    <style>
        :root {
            /* Balanced Theme */
            --bg-app: #1a1a1a;
            --bg-panel: #2a2a2a;
            --bg-display: #333333;
            --text-main: #ffffff;
            --text-muted: #cccccc;
            --text-history: #dddddd;
            
            /* Button Colors */
            --color-feet-bg: #3a6db0;
            --color-inch-bg: #4a8a4a;
            --color-frac-bg: #2a7a7a;
            --color-op-bg: #d67a2a;
            --color-action-bg: #4a5a6a;
            --color-danger: #b03a3a;
            --color-success: #3a8a3a;
            --color-result: #4a9c4a;
            
            /* Accuracy Colors */
            --color-accuracy-16: #3a6db0;
            --color-accuracy-32: #4a8a4a;
            --color-accuracy-64: #2a7a7a;
            --color-accuracy-128: #d67a2a;
            
            --btn-radius: 4px;
            --gap: 4px;
        }

        * { 
            box-sizing: border-box; 
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 6px;
        }

        .calculator-wrapper {
            width: 100%;
            max-width: 460px;
            background-color: var(--bg-panel);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: var(--gap);
            padding: 8px; /* Reduced padding */
        }

        /* --- DISPLAY SECTION --- */
        .display-container {
            background-color: var(--bg-display);
            border-radius: 6px;
            padding: 6px; /* Reduced */
            text-align: right;
            border: 1px solid #444444;
            min-height: 100px; /* Reduced */
            display: flex;
            flex-direction: column;
        }

        .history-container {
            height: 55px; /* Reduced */
            overflow-y: auto;
            margin-bottom: 5px; /* Reduced */
            padding-right: 4px;
        }

        .history-line {
            font-size: 0.7rem;
            color: var(--text-history);
            margin-bottom: 2px;
            line-height: 1.2;
            text-align: left;
            word-break: break-word;
            padding: 1px 0;
        }

        .history-line:last-child {
            margin-bottom: 0;
        }

        .main-display {
            font-size: 1.7rem; /* Reduced */
            font-weight: 600;
            color: var(--text-main);
            height: 36px; /* Reduced */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            transition: all 0.3s ease;
            border-bottom: 1px solid #444444;
            padding-bottom: 3px; /* Reduced */
            margin-bottom: 3px; /* Reduced */
        }

        .main-display.result {
            color: var(--color-result);
        }

        .sub-display {
            font-size: 0.72rem; /* Reduced */
            color: var(--text-muted);
            min-height: 16px; /* Reduced */
            font-weight: 500;
        }

        .history-container::-webkit-scrollbar {
            width: 4px;
        }

        .history-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }

        .history-container::-webkit-scrollbar-thumb {
            background: var(--color-op-bg);
            border-radius: 2px;
            opacity: 0.7;
        }

        /* --- TABS --- */
        .tabs {
            display: flex;
            gap: 3px;
            background: #3a3a3a;
            padding: 3px;
            border-radius: 4px;
            margin-bottom: 5px; /* Reduced */
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 5px 3px; /* Reduced */
            font-weight: 500;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            font-size: 0.78rem; /* Reduced */
            white-space: nowrap;
        }

        .tab-btn.active {
            background-color: var(--color-feet-bg);
            color: white;
        }
        
        /* --- PANEL VISIBILITY --- */
        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* --- DUAL KEYPADS with SMALLER BUTTONS --- */
        .dual-keypad-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--gap);
            margin-bottom: var(--gap);
        }

        .pad-section {
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            padding: 5px; /* Reduced */
            border: 1px solid rgba(255,255,255,0.1);
        }

        .pad-header {
            text-align: center;
            font-size: 0.72rem; /* Reduced */
            font-weight: 600;
            margin-bottom: 4px;
        }

        .lbl-ft { color: #8bb5ff; }
        .lbl-in { color: #9ccc9c; }

        /* SMALLER BUTTONS */
        .num-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px; /* Reduced */
        }

        button.btn {
            border: none;
            border-radius: var(--btn-radius);
            font-size: 0.88rem; /* Reduced */
            font-weight: 500;
            color: white;
            padding: 6px 0; /* Reduced from 8px */
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            user-select: none;
            -webkit-user-select: none;
            min-height: 30px; /* Reduced from 36px */
        }
        
        button.btn:hover {
            filter: brightness(1.1);
        }
        
        button.btn:active { 
            transform: translateY(1px); 
            box-shadow: none; 
            filter: brightness(0.9);
        }

        .btn-ft { 
            background-color: var(--color-feet-bg); 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-in { 
            background-color: var(--color-inch-bg); 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-frac { 
            background-color: var(--color-frac-bg); 
            font-size: 0.7rem; /* Reduced */
            padding: 5px 0; /* Reduced */
            min-height: 28px; /* Reduced */
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-op { 
            background-color: var(--color-op-bg); 
            color: #FFF; 
            font-size: 0.95rem; /* Reduced */
            padding: 6px 0; /* Reduced */
        }
        .btn-act { 
            background-color: var(--color-action-bg); 
            font-size: 0.7rem; /* Reduced */
            padding: 6px 0; /* Reduced */
        }
        .btn-danger { 
            background-color: var(--color-danger); 
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .btn-wide { grid-column: span 2; }
        
        /* Fractions Section */
        .frac-section {
            background: rgba(255,255,255,0.05);
            padding: 6px;
            border-radius: 6px;
            margin-bottom: var(--gap);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .frac-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px; /* Reduced */
            margin-top: 6px;
        }

        /* Custom Fraction Input */
        .custom-frac-row {
            display: flex;
            gap: 4px;
            margin-bottom: 5px;
        }
        
        .custom-frac-input {
            flex: 1;
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            color: var(--text-main);
            border-radius: 3px;
            padding: 5px 8px; /* Reduced */
            font-size: 0.78rem; /* Reduced */
            text-align: center;
            transition: border-color 0.2s;
        }
        
        .custom-frac-input:focus {
            outline: none;
            border-color: var(--color-frac-bg);
        }
        
        .custom-frac-input::placeholder {
            color: #888888;
        }

        /* === ACCURACY SELECTION === */
        .accuracy-section {
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            padding: 6px;
            margin-bottom: var(--gap);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .accuracy-title {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: #7acccc;
            margin-bottom: 6px;
        }

        .accuracy-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px; /* Reduced */
        }

        .btn-accuracy {
            background-color: var(--color-action-bg);
            font-size: 0.7rem; /* Reduced */
            padding: 5px 0; /* Reduced */
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-accuracy.active {
            background-color: var(--color-frac-bg);
            font-weight: 600;
        }

        /* === OPERATIONS SECTION === */
        .operations-section {
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            padding: 6px; /* Reduced */
            margin-bottom: var(--gap);
            border: 2px solid var(--color-op-bg);
            border-left-width: 6px;
        }

        .operations-section-title {
            text-align: center;
            font-size: 0.78rem; /* Reduced */
            font-weight: 600;
            color: var(--color-op-bg);
            margin-bottom: 6px; /* Reduced */
            text-transform: uppercase;
            letter-spacing: 0.5px; /* Reduced */
        }

        /* Operations & Actions Grids */
        .ops-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--gap);
            margin-bottom: var(--gap);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--gap);
        }

        /* Preview Displays */
        .input-preview {
            background: #3a3a3a;
            color: #FFF;
            text-align: center;
            padding: 4px;
            margin-bottom: 4px;
            border-radius: 3px;
            font-size: 1.0rem; /* Reduced */
            min-height: 26px; /* Reduced */
            border: 1px solid #4a4a4a;
            font-weight: 500;
        }

        /* === DIRECT CONVERSION SECTION === */
        .direct-conversion {
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            padding: 6px; /* Reduced */
            margin-top: 6px; /* Reduced */
            border: 1px solid rgba(255,255,255,0.1);
        }

        .direct-conversion-title {
            text-align: center;
            font-size: 0.78rem; /* Reduced */
            font-weight: 600;
            color: var(--color-frac-bg);
            margin-bottom: 6px; /* Reduced */
        }

        .conversion-input-row {
            display: flex;
            gap: 4px; /* Reduced */
            margin-bottom: 5px; /* Reduced */
            align-items: center;
        }

        .conversion-input {
            flex: 1;
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            color: var(--text-main);
            border-radius: 3px;
            padding: 5px 6px; /* Reduced */
            font-size: 0.8rem; /* Reduced */
            text-align: center;
        }

        .conversion-input:focus {
            outline: none;
            border-color: var(--color-frac-bg);
        }

        .unit-select {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            color: var(--text-main);
            border-radius: 3px;
            padding: 5px; /* Reduced */
            font-size: 0.72rem; /* Reduced */
            min-width: 55px; /* Reduced */
        }

        .conversion-result {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 3px;
            padding: 6px; /* Reduced */
            font-size: 0.8rem; /* Reduced */
            text-align: center;
            min-height: 36px; /* Reduced */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 5px; /* Reduced */
            color: var(--text-history);
        }

        /* Unit Converter Grid */
        .converter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--gap);
        }

        /* Normal Calculator */
        .normal-calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px; /* Reduced */
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 12px; /* Reduced */
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-success);
            color: white;
            padding: 6px 12px; /* Reduced */
            border-radius: 3px;
            z-index: 1000;
            animation: slideDown 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            font-weight: 500;
            font-size: 0.8rem; /* Reduced */
            max-width: 90%;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -12px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        /* Make equals button more prominent */
        .btn-equals {
            background-color: var(--color-success);
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-equals:hover {
            filter: brightness(1.1);
        }

        .keyboard-hint {
            color: var(--text-muted);
            font-size: 0.62rem; /* Reduced */
            text-align: center;
            margin-top: 5px; /* Reduced */
            padding-top: 5px; /* Reduced */
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .footer-info {
            color: #777777;
            font-size: 0.58rem; /* Reduced */
            text-align: center;
            margin-top: 2px;
        }
    </style>
</head>
<body>

<div class="calculator-wrapper">
    <!-- Display Section -->
    <div class="display-container">
        <!-- History Container with Fixed Height -->
        <div class="history-container" id="historyContainer">
            <!-- History lines will be inserted here by JavaScript -->
        </div>
        
        <!-- Main Display -->
        <div class="main-display" id="display">0' 0"</div>
        <div class="sub-display" id="subDisplay">0.0000 ft</div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchMode('feet-inch')">Feet-Inch</button>
        <button class="tab-btn" onclick="switchMode('normal')">Normal</button>
        <button class="tab-btn" onclick="switchMode('convert')">Convert</button>
    </div>

    <!-- === MODE: FEET-INCH === -->
    <div id="panel-feet-inch" class="panel active">
        
        <!-- Dual Keypads -->
        <div class="dual-keypad-row">
            <!-- FEET -->
            <div class="pad-section">
                <div class="pad-header lbl-ft">FEET</div>
                <div class="input-preview" id="previewFeet">0</div>
                <div class="num-grid">
                    <button class="btn btn-ft" onclick="fi.appendFeet(7)">7</button>
                    <button class="btn btn-ft" onclick="fi.appendFeet(8)">8</button>
                    <button class="btn btn-ft" onclick="fi.appendFeet(9)">9</button>
                    <button class="btn btn-ft" onclick="fi.appendFeet(4)">4</button>
                    <button class="btn btn-ft" onclick="fi.appendFeet(5)">5</button>
                    <button class="btn btn-ft" onclick="fi.appendFeet(6)">6</button>
                    <button class="btn btn-ft" onclick="fi.appendFeet(1)">1</button>
                    <button class="btn btn-ft" onclick="fi.appendFeet(2)">2</button>
                    <button class="btn btn-ft" onclick="fi.appendFeet(3)">3</button>
                    <button class="btn btn-danger" onclick="fi.clearFeet()">C</button>
                    <button class="btn btn-ft" onclick="fi.appendFeet(0)">0</button>
                    <button class="btn btn-danger" onclick="fi.backspaceFeet()">⌫</button>
                </div>
            </div>

            <!-- INCHES -->
            <div class="pad-section">
                <div class="pad-header lbl-in">INCHES</div>
                <div class="input-preview" id="previewInch">0</div>
                <div class="num-grid">
                    <button class="btn btn-in" onclick="fi.appendInch(7)">7</button>
                    <button class="btn btn-in" onclick="fi.appendInch(8)">8</button>
                    <button class="btn btn-in" onclick="fi.appendInch(9)">9</button>
                    <button class="btn btn-in" onclick="fi.appendInch(4)">4</button>
                    <button class="btn btn-in" onclick="fi.appendInch(5)">5</button>
                    <button class="btn btn-in" onclick="fi.appendInch(6)">6</button>
                    <button class="btn btn-in" onclick="fi.appendInch(1)">1</button>
                    <button class="btn btn-in" onclick="fi.appendInch(2)">2</button>
                    <button class="btn btn-in" onclick="fi.appendInch(3)">3</button>
                    <button class="btn btn-danger" onclick="fi.clearInch()">C</button>
                    <button class="btn btn-in" onclick="fi.appendInch(0)">0</button>
                    <button class="btn btn-danger" onclick="fi.backspaceInch()">⌫</button>
                </div>
            </div>
        </div>

        <!-- Fractions Section -->
        <div class="frac-section">
            <div class="pad-header" style="color:#7acccc">FRACTIONS</div>
            
            <div class="custom-frac-row">
                <input type="text" id="customFrac" class="custom-frac-input" 
                       placeholder="Fraction (5/32) or decimal (0.125)"
                       onkeydown="handleCustomFractionKeydown(event)"
                       onkeypress="handleCustomFractionKeypress(event)">
                <button class="btn btn-act" onclick="fi.applyCustomFrac()">Set</button>
            </div>

            <div class="frac-grid">
                <button class="btn btn-frac" onclick="fi.setFrac(1,16)">1/16</button>
                <button class="btn btn-frac" onclick="fi.setFrac(1,8)">1/8</button>
                <button class="btn btn-frac" onclick="fi.setFrac(3,16)">3/16</button>
                <button class="btn btn-frac" onclick="fi.setFrac(1,4)">1/4</button>

                <button class="btn btn-frac" onclick="fi.setFrac(5,16)">5/16</button>
                <button class="btn btn-frac" onclick="fi.setFrac(3,8)">3/8</button>
                <button class="btn btn-frac" onclick="fi.setFrac(7,16)">7/16</button>
                <button class="btn btn-frac" onclick="fi.setFrac(1,2)">1/2</button>

                <button class="btn btn-frac" onclick="fi.setFrac(9,16)">9/16</button>
                <button class="btn btn-frac" onclick="fi.setFrac(5,8)">5/8</button>
                <button class="btn btn-frac" onclick="fi.setFrac(11,16)">11/16</button>
                <button class="btn btn-frac" onclick="fi.setFrac(3,4)">3/4</button>
                
                <button class="btn btn-frac" onclick="fi.setFrac(13,16)">13/16</button>
                <button class="btn btn-frac" onclick="fi.setFrac(7,8)">7/8</button>
                <button class="btn btn-frac" onclick="fi.setFrac(15,16)">15/16</button>
                <button class="btn btn-danger" onclick="fi.clearFrac()">CLR</button>
            </div>
        </div>
    </div>

    <!-- === MODE: NORMAL === -->
    <div id="panel-normal" class="panel">
        <div class="normal-calc-grid">
            <button class="btn btn-act" onclick="norm.clear()">AC</button>
            <button class="btn btn-act" onclick="norm.backspace()">⌫</button>
            <button class="btn btn-act" onclick="norm.toggleSign()">+/-</button>
            <button class="btn btn-op" onclick="norm.setOp('/')">÷</button>

            <button class="btn btn-act" onclick="norm.append('7')">7</button>
            <button class="btn btn-act" onclick="norm.append('8')">8</button>
            <button class="btn btn-act" onclick="norm.append('9')">9</button>
            <button class="btn btn-op" onclick="norm.setOp('*')">×</button>

            <button class="btn btn-act" onclick="norm.append('4')">4</button>
            <button class="btn btn-act" onclick="norm.append('5')">5</button>
            <button class="btn btn-act" onclick="norm.append('6')">6</button>
            <button class="btn btn-op" onclick="norm.setOp('-')">-</button>

            <button class="btn btn-act" onclick="norm.append('1')">1</button>
            <button class="btn btn-act" onclick="norm.append('2')">2</button>
            <button class="btn btn-act" onclick="norm.append('3')">3</button>
            <button class="btn btn-op" onclick="norm.setOp('+')">+</button>

            <button class="btn btn-act btn-wide" onclick="norm.append('0')">0</button>
            <button class="btn btn-act" onclick="norm.append('.')">.</button>
            <button class="btn btn-op" onclick="norm.calc()">=</button>
        </div>
    </div>

    <!-- === MODE: CONVERT === -->
    <div id="panel-convert" class="panel">
        <div class="pad-section">
            <div class="pad-header">CONVERT CURRENT VALUE</div>
            <div class="converter-grid">
                <button class="btn btn-act" onclick="conv.toMM()">To mm</button>
                <button class="btn btn-act" onclick="conv.toCM()">To cm</button>
                <button class="btn btn-act" onclick="conv.toM()">To Meter</button>
                <button class="btn btn-act" onclick="conv.toFIF()">To F-I-F</button>
            </div>
            <div style="margin-top:6px; text-align:center; color:#888; font-size:0.72rem;">
                Converts the value on main display
            </div>
        </div>

        <!-- Direct Conversion Section -->
        <div class="direct-conversion">
            <div class="direct-conversion-title">DIRECT CONVERSION</div>
            
            <div class="conversion-input-row">
                <input type="text" class="conversion-input" id="directValue" placeholder="Enter value">
                <select class="unit-select" id="fromUnit">
                    <option value="mm">mm</option>
                    <option value="cm">cm</option>
                    <option value="m">m</option>
                    <option value="ft">ft</option>
                    <option value="in">in</option>
                    <option value="fif">F-I-F</option>
                </select>
                <span style="color:#888; font-size:0.75rem;">to</span>
                <select class="unit-select" id="toUnit">
                    <option value="fif">F-I-F</option>
                    <option value="mm">mm</option>
                    <option value="cm">cm</option>
                    <option value="m">m</option>
                    <option value="ft">ft</option>
                    <option value="in">in</option>
                </select>
                <button class="btn btn-act" onclick="conv.directConvert()" style="padding:5px 8px;">Convert</button>
            </div>
            
            <div class="conversion-result" id="directResult">
                Enter value and select units
            </div>
        </div>
    </div>

    <!-- === ACCURACY SELECTION === -->
    <div class="accuracy-section">
        <div class="accuracy-title">ACCURACY</div>
        <div class="accuracy-grid">
            <button class="btn btn-accuracy" id="acc16" onclick="setAccuracy(16)">1/16</button>
            <button class="btn btn-accuracy" id="acc32" onclick="setAccuracy(32)">1/32</button>
            <button class="btn btn-accuracy" id="acc64" onclick="setAccuracy(64)">1/64</button>
            <button class="btn btn-accuracy active" id="acc128" onclick="setAccuracy(128)">1/128</button>
        </div>
    </div>

    <!-- === OPERATIONS SECTION === -->
    <div class="operations-section">
        <div class="operations-section-title">Operations</div>
        
        <!-- OPERATIONS GRID -->
        <div class="ops-grid">
            <button class="btn btn-op" onclick="shared.setOp('+')">+</button>
            <button class="btn btn-op" onclick="shared.setOp('-')">-</button>
            <button class="btn btn-op" onclick="shared.setOp('*')">×</button>
            <button class="btn btn-op" onclick="shared.setOp('/')">÷</button>
            
            <button class="btn btn-op btn-equals" style="grid-column: span 2;" 
                    onclick="shared.calculate()">=</button>
            <button class="btn btn-op" onclick="fi.toggleSign()">+/-</button>
            <button class="btn btn-op" onclick="fi.convertToDecimal()">Dec</button>
        </div>

        <!-- ACTIONS GRID -->
        <div class="actions-grid">
            <button class="btn btn-act" onclick="mem.recall()">MR</button>
            <button class="btn btn-act" onclick="mem.clear()">MC</button>
            <button class="btn btn-act" onclick="mem.add()">M+</button>
            <button class="btn btn-act" onclick="mem.sub()">M-</button>
            
            <button class="btn btn-danger" onclick="shared.clearEntry()">CE</button>
            <button class="btn btn-danger" onclick="shared.clearAll()">AC</button>
            <button class="btn btn-act" onclick="shared.copy()">Copy</button>
            <button class="btn btn-act" onclick="shared.undo()">Undo</button>
        </div>
    </div>

    <div class="keyboard-hint">
        Click buttons to input values | + - * /, Enter(=), Backspace, C(clear)
    </div>
    
    <div class="footer-info">
        Construction Calculator v2.4 | Accuracy: 1/128
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    const STATE = {
        mode: 'feet-inch',
        currentDisplayUnit: 'inches',
        lastResult: null,
        accuracy: 128, // 16, 32, 64, or 128
        
        // Feet-Inch State
        fi: {
            feet: 0,
            inch: 0,
            fracNum: 0,
            fracDen: 1,
            isNeg: false,
            storedVal: null,
            op: null,
            isNewEntry: true,
        },

        // Normal State
        norm: {
            current: '0',
            stored: null,
            op: null,
            isNewEntry: true
        },

        memory: 0,
        undoStack: [],
        calcHistory: [],
        keyDebounce: {}
    };

    // DOM Elements
    const els = {
        display: document.getElementById('display'),
        subDisplay: document.getElementById('subDisplay'),
        historyContainer: document.getElementById('historyContainer'),
        previewFeet: document.getElementById('previewFeet'),
        previewInch: document.getElementById('previewInch'),
        customFrac: document.getElementById('customFrac'),
        directValue: document.getElementById('directValue'),
        fromUnit: document.getElementById('fromUnit'),
        toUnit: document.getElementById('toUnit'),
        directResult: document.getElementById('directResult'),
        panels: {
            'feet-inch': document.getElementById('panel-feet-inch'),
            'normal': document.getElementById('panel-normal'),
            'convert': document.getElementById('panel-convert')
        },
        tabs: document.querySelectorAll('.tab-btn'),
        accuracyButtons: {
            16: document.getElementById('acc16'),
            32: document.getElementById('acc32'),
            64: document.getElementById('acc64'),
            128: document.getElementById('acc128')
        }
    };

    // --- UTILITY FUNCTIONS ---
    const gcd = (a, b) => b ? gcd(b, a % b) : a;

    function showToast(message, duration = 1800) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translate(-50%, -8px)';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, duration);
    }

    function debounce(func, wait = 80) {
        return function(...args) {
            const key = func.name || 'default';
            if (STATE.keyDebounce[key]) return;
            
            STATE.keyDebounce[key] = true;
            func.apply(this, args);
            
            setTimeout(() => {
                STATE.keyDebounce[key] = false;
            }, wait);
        };
    }

    // --- HISTORY MANAGEMENT ---
    function updateHistoryDisplay() {
        const container = els.historyContainer;
        container.innerHTML = '';
        
        if (STATE.calcHistory.length === 0) {
            const line = document.createElement('div');
            line.className = 'history-line';
            line.textContent = 'Ready';
            line.style.color = '#777';
            line.style.fontStyle = 'italic';
            container.appendChild(line);
            return;
        }
        
        // Show all history entries, most recent at bottom
        STATE.calcHistory.forEach(item => {
            const line = document.createElement('div');
            line.className = 'history-line';
            line.textContent = item;
            container.appendChild(line);
        });
        
        // Scroll to bottom to show most recent
        container.scrollTop = container.scrollHeight;
    }

    function addToHistory(entry) {
        STATE.calcHistory.push(entry);
        // Keep only last 15 entries to prevent memory issues
        if (STATE.calcHistory.length > 15) {
            STATE.calcHistory.shift();
        }
        updateHistoryDisplay();
    }

    function saveState() {
        if (STATE.mode === 'feet-inch') {
            STATE.undoStack.push({
                feet: STATE.fi.feet,
                inch: STATE.fi.inch,
                fracNum: STATE.fi.fracNum,
                fracDen: STATE.fi.fracDen,
                isNeg: STATE.fi.isNeg
            });
            if (STATE.undoStack.length > 15) STATE.undoStack.shift();
        }
    }

    // --- ACCURACY MANAGEMENT ---
    function setAccuracy(denominator) {
        STATE.accuracy = denominator;
        
        // Update button states
        Object.keys(els.accuracyButtons).forEach(den => {
            els.accuracyButtons[den].classList.remove('active');
        });
        els.accuracyButtons[denominator].classList.add('active');
        
        // Update footer info
        document.querySelector('.footer-info').textContent = 
            `Construction Calculator v2.4 | Accuracy: 1/${denominator}`;
        
        // Recalculate current display with new accuracy
        if (STATE.mode === 'feet-inch' || STATE.mode === 'convert') {
            fi.updateDisplay();
        }
        
        showToast(`Accuracy set to 1/${denominator}`);
    }

    // --- MODE MANAGEMENT ---
    function switchMode(mode) {
        STATE.mode = mode;
        
        // Update tabs
        els.tabs.forEach(t => t.classList.remove('active'));
        const activeTab = Array.from(els.tabs).find(t => 
            t.textContent.toLowerCase().includes(mode.split('-')[0])
        );
        if (activeTab) activeTab.classList.add('active');

        // Update panels
        Object.keys(els.panels).forEach(k => {
            els.panels[k].classList[k === mode ? 'add' : 'remove']('active');
        });

        // Update display
        if (mode === 'feet-inch' || mode === 'convert') fi.updateDisplay();
        else if (mode === 'normal') norm.updateDisplay();
        
        updateHistoryDisplay();
    }

    // --- CUSTOM FRACTION INPUT HANDLING ---
    function handleCustomFractionKeydown(event) {
        // Allow: backspace, delete, tab, escape, enter, slash (/)
        if ([46, 8, 9, 27, 13, 110, 190, 191].includes(event.keyCode) ||
            // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
            (event.ctrlKey && [65, 67, 86, 88].includes(event.keyCode)) ||
            // Allow: home, end, left, right
            (event.keyCode >= 35 && event.keyCode <= 39)) {
            return;
        }
        
        // Allow numbers and slash
        if ((event.keyCode >= 48 && event.keyCode <= 57) || // number keys
            (event.keyCode >= 96 && event.keyCode <= 105) || // numpad
            event.keyCode === 111 || // numpad slash
            event.keyCode === 191) { // regular slash
            return;
        }
        
        // Prevent decimal point if we already have a fraction
        if (event.keyCode === 190 || event.keyCode === 110) { // decimal point
            const input = event.target.value;
            if (input.includes('/')) {
                event.preventDefault();
                return;
            }
        }
        
        event.preventDefault();
    }

    function handleCustomFractionKeypress(event) {
        // Allow Enter to submit
        if (event.key === 'Enter') {
            fi.applyCustomFrac();
        }
    }

    // --- FEET-INCH LOGIC ---
    const fi = {
        resetInput: () => {
            STATE.fi.feet = 0;
            STATE.fi.inch = 0;
            STATE.fi.fracNum = 0;
            STATE.fi.fracDen = 1;
            STATE.fi.isNeg = false;
        },

        checkNewEntry: () => {
            if (STATE.fi.isNewEntry) {
                fi.resetInput();
                STATE.fi.isNewEntry = false;
            }
            if (STATE.currentDisplayUnit !== 'inches') {
                STATE.currentDisplayUnit = 'inches';
            }
        },

        appendFeet: debounce(function(n) {
            saveState();
            fi.checkNewEntry();
            // Prevent overflow
            if (STATE.fi.feet.toString().length >= 4) {
                showToast("Feet value too large");
                return;
            }
            const str = STATE.fi.feet.toString() + n.toString();
            STATE.fi.feet = parseInt(str) || 0;
            fi.updateDisplay();
        }),

        appendInch: debounce(function(n) {
            saveState();
            fi.checkNewEntry();
            // Prevent overflow
            if (STATE.fi.inch.toString().length >= 3) {
                showToast("Inches value too large");
                return;
            }
            const str = STATE.fi.inch.toString() + n.toString();
            STATE.fi.inch = parseInt(str) || 0;
            fi.updateDisplay();
        }),

        setFrac: (n, d) => {
            saveState();
            fi.checkNewEntry();
            STATE.fi.fracNum = n;
            STATE.fi.fracDen = d;
            fi.updateDisplay();
        },

        applyCustomFrac: () => {
            const val = els.customFrac.value.trim();
            if (!val) return;
            
            try {
                // Check if it's a decimal
                if (val.includes('.') || (!val.includes('/') && !isNaN(val))) {
                    const decimal = parseFloat(val);
                    if (isNaN(decimal)) throw new Error("Invalid number");
                    
                    // Convert decimal to simplest fraction based on current accuracy
                    const tolerance = 1.0E-6;
                    let h1 = 1, h2 = 0, k1 = 0, k2 = 1;
                    let b = decimal;
                    let steps = 0;
                    
                    do {
                        const a = Math.floor(b);
                        let aux = h1;
                        h1 = a * h1 + h2;
                        h2 = aux;
                        aux = k1;
                        k1 = a * k1 + k2;
                        k2 = aux;
                        b = 1 / (b - a);
                        steps++;
                    } while (Math.abs(decimal - h1/k1) > decimal * tolerance && steps < 10 && k1 <= STATE.accuracy);
                    
                    STATE.fi.fracNum = h1;
                    STATE.fi.fracDen = k1;
                    
                } else if (val.includes('/')) {
                    // Handle fraction input
                    const parts = val.split('/');
                    const num = parseInt(parts[0]);
                    const den = parseInt(parts[1]);
                    
                    if (isNaN(num) || isNaN(den) || den <= 0) {
                        throw new Error("Invalid fraction");
                    }
                    
                    STATE.fi.fracNum = num;
                    STATE.fi.fracDen = den;
                } else {
                    throw new Error("Invalid input");
                }
                
                els.customFrac.value = '';
                fi.updateDisplay();
                
            } catch (err) {
                showToast(err.message);
            }
        },

        clearFeet: () => { saveState(); STATE.fi.feet = 0; fi.updateDisplay(); },
        clearInch: () => { saveState(); STATE.fi.inch = 0; fi.updateDisplay(); },
        clearFrac: () => { saveState(); STATE.fi.fracNum = 0; STATE.fi.fracDen = 1; fi.updateDisplay(); },
        
        backspaceFeet: () => {
            saveState();
            STATE.fi.feet = Math.floor(STATE.fi.feet / 10);
            fi.updateDisplay();
        },
        
        backspaceInch: () => {
            saveState();
            STATE.fi.inch = Math.floor(STATE.fi.inch / 10);
            fi.updateDisplay();
        },

        toggleSign: () => {
            STATE.fi.isNeg = !STATE.fi.isNeg;
            fi.updateDisplay();
        },

        convertToDecimal: () => {
            STATE.currentDisplayUnit = STATE.currentDisplayUnit === 'decimal' ? 'inches' : 'decimal';
            fi.updateDisplay();
        },

        getTotalInches: () => {
            let inches = (STATE.fi.feet * 12) + STATE.fi.inch + (STATE.fi.fracNum / STATE.fi.fracDen);
            return STATE.fi.isNeg ? -inches : inches;
        },

        setFromTotalInches: (total) => {
            try {
                STATE.fi.isNeg = total < 0;
                const abs = Math.abs(total);
                
                STATE.fi.feet = Math.floor(abs / 12);
                let rem = abs - (STATE.fi.feet * 12);
                STATE.fi.inch = Math.floor(rem);
                
                let frac = rem - STATE.fi.inch;
                // Use current accuracy for rounding
                let numerator = Math.round(frac * STATE.accuracy);

                // Handle carry-over
                if (numerator === STATE.accuracy) {
                    STATE.fi.inch++;
                    numerator = 0;
                }
                if (STATE.fi.inch === 12) {
                    STATE.fi.feet++;
                    STATE.fi.inch = 0;
                }

                if (numerator > 0) {
                    const div = gcd(numerator, STATE.accuracy);
                    STATE.fi.fracNum = numerator / div;
                    STATE.fi.fracDen = STATE.accuracy / div;
                } else {
                    STATE.fi.fracNum = 0;
                    STATE.fi.fracDen = 1;
                }
            } catch (err) {
                showToast("Invalid value conversion");
            }
        },

        updateDisplay: () => {
            const totInches = fi.getTotalInches();
            
            els.previewFeet.textContent = STATE.fi.feet;
            els.previewInch.textContent = STATE.fi.inch;

            let mainText = '';
            let subText = '';

            // Format Feet-Inch-Fraction string
            const fiString = shared.formatFeetInch(totInches, false);

            if (STATE.currentDisplayUnit === 'inches') {
                mainText = fiString;
                subText = `${(totInches/12).toFixed(4)} ft`;

            } else if (STATE.currentDisplayUnit === 'decimal') {
                mainText = (totInches / 12).toFixed(6) + ' ft';
                subText = fiString;

            } else {
                // Metric Display
                const absInches = Math.abs(totInches);
                let metricVal;
                let unitLabel;

                switch(STATE.currentDisplayUnit) {
                    case 'mm': metricVal = absInches * 25.4; unitLabel = 'mm'; break;
                    case 'cm': metricVal = absInches * 2.54; unitLabel = 'cm'; break;
                    case 'm': metricVal = absInches * 0.0254; unitLabel = 'm'; break;
                }
                
                mainText = (STATE.fi.isNeg ? "- " : "") + metricVal.toFixed(4) + ' ' + unitLabel;
                subText = fiString;
            }

            els.display.textContent = mainText;
            els.subDisplay.textContent = subText;
            
            // Highlight result
            if (STATE.lastResult === totInches) {
                els.display.classList.add('result');
            } else {
                els.display.classList.remove('result');
            }
        }
    };

    // --- NORMAL MODE LOGIC ---
    const norm = {
        append: debounce(function(v) {
            if (STATE.norm.isNewEntry) {
                STATE.norm.current = '';
                STATE.norm.isNewEntry = false;
            }
            if (v === '.' && STATE.norm.current.includes('.')) return;
            STATE.norm.current = (STATE.norm.current === '0' && v !== '.') ? v : STATE.norm.current + v;
            norm.updateDisplay();
        }),

        clear: () => {
            STATE.norm.current = '0';
            STATE.norm.stored = null;
            STATE.norm.op = null;
            norm.updateDisplay();
            updateHistoryDisplay();
        },

        setOp: (op) => {
            if (STATE.norm.stored === null) {
                STATE.norm.stored = parseFloat(STATE.norm.current);
            } else if (!STATE.norm.isNewEntry) {
                norm.calcIntermediate();
            }
            STATE.norm.op = op;
            STATE.norm.isNewEntry = true;
        },

        calcIntermediate: () => {
            try {
                const cur = parseFloat(STATE.norm.current);
                const res = shared.doMath(STATE.norm.stored, cur, STATE.norm.op);
                STATE.norm.stored = res;
                STATE.norm.current = res.toString();
            } catch (err) {
                showToast("Calculation error");
            }
        },

        calc: () => {
            if (STATE.norm.op && STATE.norm.stored !== null) {
                try {
                    const valA = STATE.norm.stored;
                    const op = STATE.norm.op;
                    const valB = parseFloat(STATE.norm.current);
                    
                    norm.calcIntermediate();
                    
                    // Add to history
                    addToHistory(`${valA} ${op} ${valB} = ${STATE.norm.current}`);
                    
                    STATE.norm.op = null;
                    STATE.norm.isNewEntry = true;
                    STATE.lastResult = parseFloat(STATE.norm.current);
                    norm.updateDisplay();
                } catch (err) {
                    showToast("Calculation failed");
                }
            }
        },

        backspace: () => {
            STATE.norm.current = STATE.norm.current.slice(0, -1) || '0';
            norm.updateDisplay();
        },

        toggleSign: () => {
            STATE.norm.current = (parseFloat(STATE.norm.current) * -1).toString();
            norm.updateDisplay();
        },

        updateDisplay: () => {
            els.display.textContent = STATE.norm.current;
            els.subDisplay.textContent = 'Normal Calculator';
            
            if (STATE.lastResult === parseFloat(STATE.norm.current)) {
                els.display.classList.add('result');
            } else {
                els.display.classList.remove('result');
            }
        }
    };

    // --- SHARED LOGIC ---
    const shared = {
        doMath: (a, b, op) => {
            try {
                switch(op) {
                    case '+': return a + b;
                    case '-': return a - b;
                    case '*': 
                    case '×': return a * b;
                    case '/': 
                    case '÷': 
                        if (Math.abs(b) < 0.0000001) {
                            showToast("Division by zero");
                            return a;
                        }
                        return a / b;
                    default: return b;
                }
            } catch (err) {
                showToast("Math operation failed");
                return a || 0;
            }
        },

        formatFeetInch: (totalInches, fullDisplay) => {
            const isNeg = totalInches < 0;
            const abs = Math.abs(totalInches);
            
            const feet = Math.floor(abs / 12);
            let rem = abs - (feet * 12);
            const inch = Math.floor(rem);
            
            let frac = rem - inch;
            // Use current accuracy for rounding
            let numerator = Math.round(frac * STATE.accuracy);

            if (numerator === STATE.accuracy) {
                inch++;
                numerator = 0;
            }
            const finalFeet = feet + Math.floor(inch / 12);
            const finalInch = inch % 12;

            let fracString = '';
            if (numerator > 0) {
                const div = gcd(numerator, STATE.accuracy);
                const num = numerator / div;
                const den = STATE.accuracy / div;
                fracString = ` ${num}/${den}`;
            }

            let str = isNeg ? "- " : "";
            str += `${finalFeet}' ${finalInch}"`;
            str += fracString;
            
            return str;
        },

        setOp: (op) => {
            if (STATE.mode === 'normal') {
                norm.setOp(op);
                return;
            }
            
            STATE.currentDisplayUnit = 'inches';
            const currentVal = fi.getTotalInches();

            if (STATE.fi.storedVal === null) {
                STATE.fi.storedVal = currentVal;
            } else if (!STATE.fi.isNewEntry) {
                const currentOp = STATE.fi.op;
                const res = shared.doMath(STATE.fi.storedVal, currentVal, currentOp);
                
                addToHistory(`${shared.formatFeetInch(STATE.fi.storedVal, true)} ${currentOp} ${shared.formatFeetInch(currentVal, true)} = ${shared.formatFeetInch(res, true)}`);

                STATE.fi.storedVal = res;
                fi.setFromTotalInches(res);
            }
            STATE.fi.op = op;
            STATE.fi.isNewEntry = true;
        },

        calculate: () => {
            if (STATE.mode === 'normal') {
                norm.calc();
                return;
            }

            if (STATE.fi.op && STATE.fi.storedVal !== null) {
                const currentOp = STATE.fi.op;
                const valA = STATE.fi.storedVal;
                const valB = fi.getTotalInches();
                const res = shared.doMath(valA, valB, currentOp);
                
                // Add to history
                addToHistory(`${shared.formatFeetInch(valA, true)} ${currentOp} ${shared.formatFeetInch(valB, true)} = ${shared.formatFeetInch(res, true)}`);
                
                STATE.fi.storedVal = null;
                STATE.fi.op = null;
                STATE.fi.isNewEntry = true;
                STATE.lastResult = res;
                
                fi.setFromTotalInches(res);
                fi.updateDisplay();
            }
        },

        clearEntry: () => {
            if (STATE.mode === 'normal') {
                STATE.norm.current = '0';
                norm.updateDisplay();
            } else {
                fi.resetInput();
                STATE.fi.isNewEntry = true;
                STATE.currentDisplayUnit = 'inches';
                fi.updateDisplay();
            }
        },

        clearAll: () => {
            fi.resetInput();
            STATE.fi.storedVal = null;
            STATE.fi.op = null;
            STATE.fi.isNewEntry = true;
            STATE.currentDisplayUnit = 'inches';
            
            norm.clear();
            STATE.calcHistory = [];
            STATE.lastResult = null;
            
            if (STATE.mode === 'feet-inch') fi.updateDisplay();
            updateHistoryDisplay();
            showToast("All cleared");
        },

        copy: () => {
            const textToCopy = els.display.textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast("Copied!");
                }).catch(err => {
                    console.error("Copy failed:", err);
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast("Copied!");
            }
        },
        
        undo: () => {
            if (STATE.undoStack.length > 0) {
                const prev = STATE.undoStack.pop();
                STATE.fi = { ...STATE.fi, ...prev };
                if (STATE.mode === 'feet-inch') fi.updateDisplay();
                showToast("Undo successful");
            } else {
                showToast("Nothing to undo");
            }
        }
    };

    // --- CONVERSION LOGIC ---
    const conv = {
        toMM: () => { 
            STATE.currentDisplayUnit = 'mm'; 
            fi.updateDisplay();
        },
        
        toCM: () => { 
            STATE.currentDisplayUnit = 'cm'; 
            fi.updateDisplay();
        },
        
        toM: () => { 
            STATE.currentDisplayUnit = 'm'; 
            fi.updateDisplay();
        },
        
        toFIF: () => { 
            STATE.currentDisplayUnit = 'inches'; 
            fi.updateDisplay();
        },
        
        directConvert: () => {
            const value = els.directValue.value.trim();
            if (!value) {
                els.directResult.textContent = "Please enter a value";
                return;
            }
            
            const fromUnit = els.fromUnit.value;
            const toUnit = els.toUnit.value;
            
            try {
                let result;
                
                if (fromUnit === toUnit) {
                    result = `${value} ${fromUnit}`;
                } else if (fromUnit === 'fif') {
                    // Parse F-I-F string
                    const inches = conv.parseFIF(value);
                    result = conv.convertFromInches(inches, toUnit);
                } else if (toUnit === 'fif') {
                    // Convert to inches then to F-I-F
                    const inches = conv.convertToInches(parseFloat(value), fromUnit);
                    result = shared.formatFeetInch(inches, false);
                } else {
                    // Standard unit conversion
                    const inches = conv.convertToInches(parseFloat(value), fromUnit);
                    result = conv.convertFromInches(inches, toUnit);
                }
                
                els.directResult.innerHTML = `<div style="color:#4CAF50; font-weight:600;">${value} ${fromUnit} = ${result} ${toUnit !== 'fif' ? toUnit : ''}</div>`;
                
            } catch (err) {
                els.directResult.textContent = "Invalid input or conversion";
            }
        },
        
        parseFIF: (fifString) => {
            // Parse feet-inch-fraction string
            let totalInches = 0;
            let sign = 1;
            let str = fifString.trim();
            
            // Check for negative
            if (str.startsWith('-')) {
                sign = -1;
                str = str.substring(1).trim();
            }
            
            // Extract feet
            const feetMatch = str.match(/(\d+)\s*'/);
            if (feetMatch) {
                totalInches += parseInt(feetMatch[1]) * 12;
                str = str.replace(feetMatch[0], '');
            }
            
            // Extract inches
            const inchMatch = str.match(/(\d+)\s*"/);
            if (inchMatch) {
                totalInches += parseInt(inchMatch[1]);
                str = str.replace(inchMatch[0], '');
            }
            
            // Extract fraction
            const fracMatch = str.match(/(\d+)\/(\d+)/);
            if (fracMatch) {
                const num = parseInt(fracMatch[1]);
                const den = parseInt(fracMatch[2]);
                totalInches += num / den;
            }
            
            return totalInches * sign;
        },
        
        convertToInches: (value, fromUnit) => {
            switch(fromUnit) {
                case 'mm': return value / 25.4;
                case 'cm': return value / 2.54;
                case 'm': return value * 39.3701;
                case 'ft': return value * 12;
                case 'in': return value;
                default: throw new Error("Unknown unit");
            }
        },
        
        convertFromInches: (inches, toUnit) => {
            switch(toUnit) {
                case 'mm': return (inches * 25.4).toFixed(2);
                case 'cm': return (inches * 2.54).toFixed(2);
                case 'm': return (inches * 0.0254).toFixed(3);
                case 'ft': return (inches / 12).toFixed(4);
                case 'in': return inches.toFixed(3);
                default: throw new Error("Unknown unit");
            }
        }
    };

    // --- MEMORY ---
    const mem = {
        getCurrentValue: () => {
            return STATE.mode === 'feet-inch' ? fi.getTotalInches() : parseFloat(STATE.norm.current);
        },
        
        add: () => {
            STATE.memory += mem.getCurrentValue();
            showToast(`M+ ${mem.getCurrentValue().toFixed(4)}`);
        },
        
        sub: () => {
            STATE.memory -= mem.getCurrentValue();
            showToast(`M- ${mem.getCurrentValue().toFixed(4)}`);
        },
        
        recall: () => {
            if (STATE.mode === 'feet-inch') {
                fi.setFromTotalInches(STATE.memory);
                fi.updateDisplay();
            } else {
                STATE.norm.current = STATE.memory.toString();
                norm.updateDisplay();
            }
            showToast("Memory recalled");
        },
        
        clear: () => { 
            STATE.memory = 0; 
            showToast("Memory cleared");
        }
    };

    // --- INITIALIZATION ---
    switchMode('feet-inch');
    fi.updateDisplay();
    updateHistoryDisplay();

    // Auto-clear custom fraction input on focus
    els.customFrac.addEventListener('focus', function() {
        this.select();
    });

    // Auto-format common decimals
    els.customFrac.addEventListener('blur', function() {
        const val = this.value.trim();
        if (val && !val.includes('/')) {
            const num = parseFloat(val);
            if (!isNaN(num)) {
                const commonDecimals = {
                    '0.125': '1/8',
                    '0.25': '1/4',
                    '0.375': '3/8',
                    '0.5': '1/2',
                    '0.625': '5/8',
                    '0.75': '3/4',
                    '0.875': '7/8'
                };
                
                const key = num.toFixed(3);
                if (commonDecimals[key]) {
                    this.value = commonDecimals[key];
                }
            }
        }
    });

    // Handle Enter key in direct conversion input
    els.directValue.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            conv.directConvert();
        }
    });
</script>

<script async id="netlify-rum-container" src="/.netlify/scripts/rum" data-netlify-rum-site-id="63183dc4-bd3e-4dd8-94ea-ab80722f9638" data-netlify-deploy-branch="" data-netlify-deploy-context="production" data-netlify-cwv-token="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzaXRlX2lkIjoiNjMxODNkYzQtYmQzZS00ZGQ4LTk0ZWEtYWI4MDcyMmY5NjM4IiwiYWNjb3VudF9pZCI6IjY5M2MwMDU5ZDE3NzUwMmMzZGE5NGEwNiIsImRlcGxveV9pZCI6IjY5M2MxMGE1NThlNjU2NmQ1M2JmMjRhMiIsImlzc3VlciI6Im5mc2VydmVyIn0.i8WI2laBLqNIOxRnZtlLJ2icbhSZNus4MZF-9nzM4ys"></script></body>
</html>
